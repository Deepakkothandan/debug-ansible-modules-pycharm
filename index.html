<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-dark.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>Debug Ansible Modules in PyCharm on Windows by mmumshad</title>
  </head>

  <body>
    <div id="container">
      <div class="inner">

        <header>
          <h1>Debug Ansible Modules in PyCharm on Windows</h1>
          <h2>Debug Ansible Modules remotely in PyCharm on windows</h2>
        </header>

        <section id="downloads" class="clearfix">
          <a href="https://github.com/mmumshad/debug-ansible-modules-pycharm/zipball/master" id="download-zip" class="button"><span>Download .zip</span></a>
          <a href="https://github.com/mmumshad/debug-ansible-modules-pycharm/tarball/master" id="download-tar-gz" class="button"><span>Download .tar.gz</span></a>
          <a href="https://github.com/mmumshad/debug-ansible-modules-pycharm" id="view-on-github" class="button"><span>View on GitHub</span></a>
        </section>

        <hr>

        <section id="main_content">
          <h3>
<a id="introduction" class="anchor" href="#introduction" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Introduction</h3>

<p>I have been developing custom <a href="https://www.ansible.com/">Ansible</a> modules on my windows system using <a href="https://www.jetbrains.com/pycharm/">JetBrains PyCharm IDE</a>. Below I describe some challenges and best practices on the development and how to debug remotely. </p>

<p>For information about developing custom modules using Ansible check <a href="http://docs.ansible.com/ansible/developing_modules.html">here</a>.</p>

<h2>
<a id="challenge" class="anchor" href="#challenge" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Challenge</h2>

<p>Though Ansible supports configuring Windows systems, Ansible itself <a href="http://docs.ansible.com/ansible/intro_windows.html#reminder-you-must-have-a-linux-control-machine">cannot</a> be run on a windows control machine. If you are developing custom Ansible modules on a Windows Machine you might find it difficult to debug. This can be difficult if you are used to debugging in the IDE. The <a href="https://github.com/ansible/ansible/blob/devel/hacking/test-module">test-module</a> offers some debug options if you are good with debugging in the Linux console. </p>

<p>In this article I explain how to debug using the IDE debugger on a windows system by running the module remotely on a Ansible controller Linux system.</p>

<h3>
<a id="development-environment-setup-and-pre-requisites" class="anchor" href="#development-environment-setup-and-pre-requisites" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Development Environment Setup and Pre-requisites</h3>

<p>Below is my development environment:</p>

<ul>
<li>Development system - Windows 7</li>
<li>Development IDE - <a href="https://www.jetbrains.com/pycharm/">JetBrains PyCharm IDE</a> Professional Edition *</li>
<li>Ansible Controller - OpenSuse Linux Machine with Ansible installed. Must have network connectivity with the Development Windows System.</li>
<li>Must have the Ansible devel package downloaded on the Linux Controller Machine to test custom modules - <a href="https://github.com/ansible/ansible/blob/devel/hacking/test-module">test-module</a>. For instructions on setting this up, please see <a href="http://docs.ansible.com/ansible/intro_installation.html">Installation</a>.</li>
</ul>

<blockquote>
<p>* Must have a <a href="https://www.jetbrains.com/pycharm/download">JetBrains PyCharm Professional Edition</a> for remote debugging features. Community edition <a href="https://www.jetbrains.com/pycharm/features/">does not</a> support remote debugging. If you have not purchased already You can get a free trial of Professional Edition for 30 days.</p>
</blockquote>

<h3>
<a id="develop-custom-ansible-module" class="anchor" href="#develop-custom-ansible-module" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Develop Custom Ansible Module</h3>

<p>Create a new project in JetBrains PyCharm and create a new file in the project named - 'OSCheckModule.py'</p>

<p>If you have never developed a custom Ansible module, start <a href="http://docs.ansible.com/ansible/developing_modules.html">here</a>.
Start from the Common base template and build your module. Here I have a custom module called <strong>OSCheckModule</strong> that checks the OS flavor against a given input :</p>

<div class="highlight highlight-source-python"><pre><span class="pl-c">#!/usr/bin/python</span>

<span class="pl-k">try</span>:
    <span class="pl-k">import</span> json
<span class="pl-k">except</span> <span class="pl-c1">ImportError</span>:
    <span class="pl-k">import</span> simplejson <span class="pl-k">as</span> json

<span class="pl-k">import</span> os

<span class="pl-c1">DOCUMENTATION</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'''</span></span>
<span class="pl-s">---</span>
<span class="pl-s">module: OSCheckModule</span>
<span class="pl-s">short_description: A custom module to check OS of target machine.</span>
<span class="pl-s">description:</span>
<span class="pl-s">        - A custom module to check OS of target machine.</span>
<span class="pl-s">options:</span>
<span class="pl-s">  os_name:</span>
<span class="pl-s">    description:</span>
<span class="pl-s">      - Name of OS to check</span>
<span class="pl-s">    required: true</span>
<span class="pl-s"><span class="pl-pds">'''</span></span>

<span class="pl-c1">EXAMPLES</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'''</span></span>
<span class="pl-s"># Example</span>
<span class="pl-s">module_name:</span>
<span class="pl-s">    os_name: Linux</span>
<span class="pl-s"><span class="pl-pds">'''</span></span>


<span class="pl-k">def</span> <span class="pl-en">main</span>():
    module <span class="pl-k">=</span> AnsibleModule(
        <span class="pl-v">argument_spec</span><span class="pl-k">=</span><span class="pl-c1">dict</span>(
            <span class="pl-v">os_name</span><span class="pl-k">=</span><span class="pl-c1">dict</span>(<span class="pl-v">required</span><span class="pl-k">=</span><span class="pl-c1">True</span>),
        )
    )

    <span class="pl-c"># Retreive parameters</span>
    os_name <span class="pl-k">=</span> module.params[<span class="pl-s"><span class="pl-pds">'</span>os_name<span class="pl-pds">'</span></span>]

    <span class="pl-c"># Check for OS</span>
    <span class="pl-k">if</span> os_name <span class="pl-k">in</span> os.uname():
        <span class="pl-c"># Successfull Exit</span>
        module.exit_json(<span class="pl-v">changed</span><span class="pl-k">=</span><span class="pl-c1">True</span>, <span class="pl-v">msg</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>OS Match<span class="pl-pds">"</span></span>)
    <span class="pl-k">else</span>:
        <span class="pl-c"># Fail Exit</span>
        module.fail_json(<span class="pl-v">msg</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>OS Mismatch. OS =<span class="pl-pds">"</span></span> <span class="pl-k">+</span> os.uname()[<span class="pl-c1">0</span>])


<span class="pl-k">from</span> ansible.module_utils.basic <span class="pl-k">import</span> AnsibleModule

<span class="pl-k">if</span> <span class="pl-c1">__name__</span> <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">'</span>__main__<span class="pl-pds">'</span></span>:
    main()</pre></div>

<p>We are ready with our first custom module. We will now copy this fiel to our Linux Controller Machine for execution. We can use PyCharm's remote Python interpretor feature to push and run the script remotely on the Linux Controller machine without having to manually copy over. Read about it <a href="https://www.jetbrains.com/help/pycharm/2016.1/configuring-remote-python-interpreters.html">here</a>. Will blog about it another time.</p>

<h3>
<a id="executing-custom-ansible-module" class="anchor" href="#executing-custom-ansible-module" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Executing Custom Ansible Module</h3>

<p>I have copied my new module file to the path <code>/opt/ansible/custom_modules</code> in my Linux Ansible Controller Machine. I can now use the <a href="https://github.com/ansible/ansible/blob/devel/hacking/test-module">test-module</a> to test and execute my new custom ansible module. </p>

<p>Syntax:</p>

<div class="highlight highlight-text-shell-session"><pre><span class="pl-mo">/opt/ansible/ansible-devel/hacking/test-module -m &lt;module file&gt; -a &lt;module arguments&gt;</span></pre></div>

<p>Example:</p>

<div class="highlight highlight-text-shell-session"><pre><span class="pl-e">root:/opt/ansible/custom_modules</span> # <span class="pl-s1">/opt/ansible/ansible-devel/hacking/test-module -m OSCheckModule.py -a os_name=Linux</span>
<span class="pl-mo">* including generated source, if any, saving to: /root/.ansible_module_generated</span>
<span class="pl-mo">* this may offset any line numbers in tracebacks/debuggers!</span>
<span class="pl-mo">***********************************</span>
<span class="pl-mo">RAW OUTPUT</span>

<span class="pl-mo">{"msg": "OS Match", "invocation": {"module_args": {"os_name": "Linux"}}, "changed": true}</span>


<span class="pl-mo">***********************************</span>
<span class="pl-mo">PARSED OUTPUT</span>
<span class="pl-mo">{</span>
<span class="pl-mo">    "changed": true,</span>
<span class="pl-mo">    "invocation": {</span>
<span class="pl-mo">        "module_args": {</span>
<span class="pl-mo">            "os_name": "Linux"</span>
<span class="pl-mo">        }</span>
<span class="pl-mo">    },</span>
<span class="pl-mo">    "msg": "OS Match"</span>
<span class="pl-mo">}</span>
</pre></div>

<p>Wow!! we have successfully created and tested our first Custom Ansible Module.</p>

<h3>
<a id="debugging-custom-ansible-module" class="anchor" href="#debugging-custom-ansible-module" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Debugging Custom Ansible Module</h3>

<p>We would now like to debug our custom ansible module using PyCharm debugger. For example we would like to set a break point at Line 46 to inspect the result of os.uname() call. We wouldwill use Python <a href="https://pypi.python.org/pypi/pydevd">pydevd</a> for this purpose.</p>

<h4>
<a id="install-pydevd-on-the-linux-machine-controller" class="anchor" href="#install-pydevd-on-the-linux-machine-controller" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Install pydevd on the Linux Machine Controller</h4>

<div class="highlight highlight-text-shell-session"><pre><span class="pl-mo">pip install pydevd</span></pre></div>

<h4>
<a id="setup-pycharm-debug-server" class="anchor" href="#setup-pycharm-debug-server" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Setup PyCharm Debug Server</h4>

<p>Create a new Project in PyCharm and go to <strong>Run -&gt; Edit Configurations..</strong></p>

<p>Click on the plus sign in top left corner and select Python Remote Debug. (You must be using PyCharm Professional Edition to have this feature. Ths is not available in PyCharm Community Edition.)</p>

<p><img src="https://cdn.rawgit.com/mmumshad/debug-ansible-modules-pycharm/master/screenshots/pycharm_new_remote_debugger.png" alt="remote debugger"></p>

<p>Provide the following information :</p>

<ul>
<li>
<strong>Name</strong>: Give a name to the debugger - OSCheckModule_Debugger</li>
<li>
<strong>Local host name</strong>: Enter the IP of the Windows development system. Make sure you can ping and establish connectivity to this IP from your Linux System</li>
<li>
<strong>Port</strong> - Set port to 54654</li>
<li>Path mappings - Ignore</li>
<li> Leave the remaining settings to default</li>
</ul>

<p><img src="https://cdn.rawgit.com/mmumshad/debug-ansible-modules-pycharm/master/screenshots/py_charm_debugger_new_configuration.PNG" alt="remote debugger configuratin"></p>

<p>Start the PyCharm Debug server by clicking on the debug optionbutton in the top right corner</p>

<p><img src="https://cdn.rawgit.com/mmumshad/debug-ansible-modules-pycharm/master/screenshots/pycharm_debug_icon.PNG" alt="debug button"></p>

<p>The Debug server starts and starts listening for connections</p>

<p><img src="https://cdn.rawgit.com/mmumshad/debug-ansible-modules-pycharm/master/screenshots/pycharm_debug_server.PNG" alt="debug server"></p>

<p>Note down the instructions provided to configure source code:</p>

<div class="highlight highlight-text-shell-session"><pre><span class="pl-mo">Use the following code to connect to the debugger:</span>
<span class="pl-mo">import pydevd</span>
<span class="pl-mo">pydevd.settrace('10.123.12.214', port=54654, stdoutToServer=True, stderrToServer=True)</span></pre></div>

<h4>
<a id="configure-source-code" class="anchor" href="#configure-source-code" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Configure source code:</h4>

<p>Insert the following lines in the source code of the custom module - OSCheckModule.py</p>

<p>Insert import pydevd line at the top</p>

<div class="highlight highlight-source-python"><pre><span class="pl-k">import</span> pydevd</pre></div>

<p>Insert the below line to set breakpoint at line 46</p>

<div class="highlight highlight-source-python"><pre>pydevd.settrace(<span class="pl-s"><span class="pl-pds">'</span>10.123.12.214<span class="pl-pds">'</span></span>, <span class="pl-v">port</span><span class="pl-k">=</span><span class="pl-c1">54654</span>, <span class="pl-v">stdoutToServer</span><span class="pl-k">=</span><span class="pl-c1">True</span>, <span class="pl-v">stderrToServer</span><span class="pl-k">=</span><span class="pl-c1">True</span>)</pre></div>

<h4>
<a id="start-debugging" class="anchor" href="#start-debugging" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Start debugging</h4>

<p>Copy the source code to the linux system, if you have made the changes on your windows system. Run the module using test-module:</p>

<div class="highlight highlight-text-shell-session"><pre><span class="pl-e">root:/opt/ansible/custom_modules</span> # <span class="pl-s1">/opt/ansible/ansible-devel/hacking/test-module -m OSCheckModule.py -a os_name=Linux</span></pre></div>

<p>If connectivity is established between the Linux and Windows systems, a prompt will appear in PyCharm in windows. </p>

<p><img src="https://cdn.rawgit.com/mmumshad/debug-ansible-modules-pycharm/master/screenshots/py_charm_debugger_prompt.PNG" alt="debug server prompt"></p>

<p>Select the <strong>Download Source</strong> option to downlaod the source code to windows machine. The source will be downloaded the breakpoint is set. You can line step through the remainder of the code and use Debug console to view variables and their values.</p>

<p><img src="https://cdn.rawgit.com/mmumshad/debug-ansible-modules-pycharm/master/screenshots/pycharm_debug_variables.PNG" alt="debug server console"></p>

<p>Thank you for reading. Please feel free to comment, propose better solutions.</p>

<h3>
<a id="authors-and-contributors" class="anchor" href="#authors-and-contributors" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Authors and Contributors</h3>

<p>Mumshad Mannambeth (<a href="https://github.com/mmumshad" class="user-mention">@mmumshad</a>)</p>

<h3>
<a id="support-or-contact" class="anchor" href="#support-or-contact" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Support or Contact</h3>

<p>See a problem, have an issue? Raise an issue at the <a href="https://github.com/mmumshad/debug-ansible-modules-pycharm">github page</a></p>
        </section>

        <footer>
          Debug Ansible Modules in PyCharm on Windows is maintained by <a href="https://github.com/mmumshad">mmumshad</a><br>
          This page was generated by <a href="https://pages.github.com">GitHub Pages</a>. Tactile theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.
        </footer>

        
      </div>
    </div>
  </body>
</html>
