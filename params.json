{
  "name": "Debug Ansible Modules in PyCharm on Windows",
  "tagline": "Debug Ansible Modules remotely in PyCharm on windows",
  "body": "### Introduction\r\nI have been developing custom [Ansible](https://www.ansible.com/) modules on my windows system using [JetBrains PyCharm IDE](https://www.jetbrains.com/pycharm/). Below I describe some challenges and best practices on the development and how to debug remotely. \r\n\r\nFor information about developing custom modules using Ansible check [here](http://docs.ansible.com/ansible/developing_modules.html).\r\n\r\n## Challenge\r\nThough Ansible supports configuring Windows systems, Ansible itself [cannot](http://docs.ansible.com/ansible/intro_windows.html#reminder-you-must-have-a-linux-control-machine) be run on a windows control machine. If you are developing custom Ansible modules on a Windows Machine you might find it difficult to debug. This can be difficult if you are used to debugging in the IDE. The [test-module](https://github.com/ansible/ansible/blob/devel/hacking/test-module) offers some debug options if you are good with debugging in the Linux console. \r\n\r\nIn this article I explain how to debug using the IDE debugger on a windows system by running the module remotely on a Ansible controller Linux system.\r\n\r\n### Development Environment Setup and Pre-requisites\r\nBelow is my development environment:\r\n* Development system - Windows 7\r\n* Development IDE - [JetBrains PyCharm IDE](https://www.jetbrains.com/pycharm/) Professional Edition *\r\n* Ansible Controller - OpenSuse Linux Machine with Ansible installed. Must have network connectivity with the Development Windows System.\r\n* Must have the Ansible devel package downloaded on the Linux Controller Machine to test custom modules - [test-module](https://github.com/ansible/ansible/blob/devel/hacking/test-module). For instructions on setting this up, please see [Installation](http://docs.ansible.com/ansible/intro_installation.html).\r\n\r\n>\\* Must have a [JetBrains PyCharm Professional Edition](https://www.jetbrains.com/pycharm/download) for remote debugging features. Community edition [does not](https://www.jetbrains.com/pycharm/features/) support remote debugging. If you have not purchased already You can get a free trial of Professional Edition for 30 days.\r\n\r\n### Develop Custom Ansible Module\r\n\r\nCreate a new project in JetBrains PyCharm and create a new file in the project named - 'OSCheckModule.py'\r\n\r\nIf you have never developed a custom Ansible module, start [here](http://docs.ansible.com/ansible/developing_modules.html).\r\nStart from the Common base template and build your module. Here I have a custom module called **OSCheckModule** that checks the OS flavor against a given input :\r\n\r\n```\r\n#!/usr/bin/python\r\n\r\ntry:\r\n    import json\r\nexcept ImportError:\r\n    import simplejson as json\r\n\r\nimport os\r\n\r\nDOCUMENTATION = '''\r\n---\r\nmodule: OSCheckModule\r\nshort_description: A custom module to check OS of target machine.\r\ndescription:\r\n        - A custom module to check OS of target machine.\r\noptions:\r\n  os_name:\r\n    description:\r\n      - Name of OS to check\r\n    required: true\r\n'''\r\n\r\nEXAMPLES = '''\r\n# Example\r\nmodule_name:\r\n    os_name: Linux\r\n'''\r\n\r\n\r\ndef main():\r\n    module = AnsibleModule(\r\n        argument_spec=dict(\r\n            os_name=dict(required=True),\r\n        )\r\n    )\r\n\r\n    # Retreive parameters\r\n    os_name = module.params['os_name']\r\n\r\n    # Check for OS\r\n    if os_name in os.uname():\r\n        # Successfull Exit\r\n        module.exit_json(changed=True, msg=\"OS Match\")\r\n    else:\r\n        # Fail Exit\r\n        module.fail_json(msg=\"OS Mismatch. OS =\" + os.uname()[0])\r\n\r\n\r\nfrom ansible.module_utils.basic import AnsibleModule\r\n\r\nif __name__ == '__main__':\r\n    main()\r\n```\r\n\r\nWe are ready with our first custom module. We will now copy this fiel to our Linux Controller Machine for execution. We can use PyCharm's remote Python interpretor feature to push and run the script remotely on the Linux Controller machine without having to manually copy over. Read about it [here](https://www.jetbrains.com/help/pycharm/2016.1/configuring-remote-python-interpreters.html). Will blog about it another time.\r\n\r\n### Executing Custom Ansible Module\r\n\r\nI have copied my new module file to the path `/opt/ansible/custom_modules` in my Linux Ansible Controller Machine. I can now use the [test-module](https://github.com/ansible/ansible/blob/devel/hacking/test-module) to test and execute my new custom ansible module. \r\n\r\nSyntax:\r\n```\r\n/opt/ansible/ansible-devel/hacking/test-module -m <module file> -a <module arguments>\r\n```\r\n\r\nExample:\r\n\r\n```\r\nroot:/opt/ansible/custom_modules # /opt/ansible/ansible-devel/hacking/test-module -m OSCheckModule.py -a os_name=Linux\r\n* including generated source, if any, saving to: /root/.ansible_module_generated\r\n* this may offset any line numbers in tracebacks/debuggers!\r\n***********************************\r\nRAW OUTPUT\r\n\r\n{\"msg\": \"OS Match\", \"invocation\": {\"module_args\": {\"os_name\": \"Linux\"}}, \"changed\": true}\r\n\r\n\r\n***********************************\r\nPARSED OUTPUT\r\n{\r\n    \"changed\": true,\r\n    \"invocation\": {\r\n        \"module_args\": {\r\n            \"os_name\": \"Linux\"\r\n        }\r\n    },\r\n    \"msg\": \"OS Match\"\r\n}\r\n\r\n```\r\n\r\nWow!! we have successfully created and tested our first Custom Ansible Module.\r\n\r\n### Debugging Custom Ansible Module\r\n\r\nWe would now like to debug our custom ansible module using PyCharm debugger. For example we would like to set a break point at Line 46 to inspect the result of os.uname() call. We wouldwill use Python [pydevd](https://pypi.python.org/pypi/pydevd) for this purpose.\r\n\r\n#### Install pydevd on the Linux Machine Controller\r\n\r\n```\r\npip install pydevd\r\n```\r\n\r\n#### Setup PyCharm Debug Server\r\nCreate a new Project in PyCharm and go to **Run -> Edit Configurations..**\r\n\r\nClick on the plus sign in top left corner and select Python Remote Debug. (You must be using PyCharm Professional Edition to have this feature. Ths is not available in PyCharm Community Edition.)\r\n\r\n![remote debugger](https://cdn.rawgit.com/mmumshad/debug-ansible-modules-pycharm/master/screenshots/pycharm_new_remote_debugger.png)\r\n\r\nProvide the following information :\r\n* **Name**: Give a name to the debugger - OSCheckModule_Debugger\r\n* **Local host name**: Enter the IP of the Windows development system. Make sure you can ping and establish connectivity to this IP from your Linux System\r\n* **Port** - Set port to 54654\r\n* Path mappings - Ignore\r\n*  Leave the remaining settings to default\r\n\r\n![remote debugger configuratin](https://cdn.rawgit.com/mmumshad/debug-ansible-modules-pycharm/master/screenshots/py_charm_debugger_new_configuration.PNG)\r\n\r\nStart the PyCharm Debug server by clicking on the debug optionbutton in the top right corner\r\n\r\n![debug button](https://cdn.rawgit.com/mmumshad/debug-ansible-modules-pycharm/master/screenshots/pycharm_debug_icon.PNG)\r\n\r\nThe Debug server starts and starts listening for connections\r\n\r\n![debug server](https://cdn.rawgit.com/mmumshad/debug-ansible-modules-pycharm/master/screenshots/pycharm_debug_server.PNG)\r\n\r\nNote down the instructions provided to configure source code:\r\n```\r\nUse the following code to connect to the debugger:\r\nimport pydevd\r\npydevd.settrace('10.123.12.214', port=54654, stdoutToServer=True, stderrToServer=True)\r\n```\r\n\r\n#### Configure source code:\r\n\r\nInsert the following lines in the source code of the custom module - OSCheckModule.py\r\n\r\nInsert import pydevd line at the top\r\n```\r\nimport pydevd\r\n```\r\n\r\nInsert the below line to set breakpoint at line 46\r\n\r\n```\r\npydevd.settrace('10.123.12.214', port=54654, stdoutToServer=True, stderrToServer=True)\r\n```\r\n\r\n#### Start debugging\r\n\r\nCopy the source code to the linux system, if you have made the changes on your windows system. Run the module using test-module:\r\n\r\n```\r\nroot:/opt/ansible/custom_modules # /opt/ansible/ansible-devel/hacking/test-module -m OSCheckModule.py -a os_name=Linux\r\n```\r\n\r\nIf connectivity is established between the Linux and Windows systems, a prompt will appear in PyCharm in windows. \r\n\r\n![debug server prompt](https://cdn.rawgit.com/mmumshad/debug-ansible-modules-pycharm/master/screenshots/py_charm_debugger_prompt.PNG)\r\n\r\nSelect the **Download Source** option to downlaod the source code to windows machine. The source will be downloaded the breakpoint is set. You can line step through the remainder of the code and use Debug console to view variables and their values.\r\n\r\n![debug server console](https://cdn.rawgit.com/mmumshad/debug-ansible-modules-pycharm/master/screenshots/pycharm_debug_variables.PNG)\r\n\r\nThank you for reading. Please feel free to comment, propose better solutions.\r\n\r\n\r\n### Authors and Contributors\r\nMumshad Mannambeth (@mmumshad)\r\n\r\n### Support or Contact\r\nSee a problem, have an issue? Raise an issue at the [github page](https://github.com/mmumshad/debug-ansible-modules-pycharm)\r\n",
  "note": "Don't delete this file! It's used internally to help with page regeneration."
}